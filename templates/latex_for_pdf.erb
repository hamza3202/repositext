\documentclass[<%= @font_size %>pt, twoside, openright]{book}

% NOTE: in latex, bp is equivalent to PS points in other programs. A latex
% pt is different. See 5th bullet here: http://tex.stackexchange.com/a/4244

% nag to be alerted of syntax issues
\usepackage{nag}

% set rt specific relative point, to be used for all point based lengths that
% should be relative to font size. We use this to scale from book size to enlarged.
\newlength{\RtRelPt}
\setlength{\RtRelPt}{<%= @scale_factor %>pt}

% conditionally apply CJK package for chinese
<% if @use_cjk_package %>
  \usepackage[AutoFakeBold=true]{xeCJK}[2011/05/20]
  \setCJKmainfont{<%= @font_name %>}
<% end %>

% so we can render first eagle as drop cap
\usepackage{lettrine}

% sets the language specific linebreaking
\XeTeXlinebreaklocale "<%= @linebreaklocale %>"

% fontspec to use custom fonts
\usepackage{fontspec}
% turn off ligatures
\setmainfont[Ligatures={NoRequired,NoCommon,NoContextual}]{<%= @font_name %>}
% use different font for titles
\newfontfamily\titlefont[Ligatures={NoRequired,NoCommon,NoContextual}]{<%= @title_font_name %>}
\newfontfamily\paragraphnumberfont[Ligatures={NoRequired,NoCommon,NoContextual}]{<%= @paragraph_number_font_name %>}
\newfontfamily\primaryfont[Ligatures={NoRequired,NoCommon,NoContextual}]{<%= @primary_font_name %>}
\newfontfamily\rtmainfont[Ligatures={NoRequired,NoCommon,NoContextual}]{<%= @font_name %>}

<% if @polyglossia_default_language %>
  % This language requires polyglossia for correct font rendering
  \usepackage{polyglossia}
  \setdefaultlanguage{<%= @polyglossia_default_language %>}
<% end %>

% set leading for document
\usepackage{leading}

% make sure there is no page break in id paragraphs at the end
\usepackage{needspace}

% set font size relative to base font size
\usepackage{relsize}
  % forces relsize to scale by the set percentage
  \renewcommand\RSpercentTolerance{0}
  \renewcommand\RSlargest{50pt}
  \renewcommand\RSsmallest{6pt}

% ensure single line spacing is used
\usepackage[singlespacing]{setspace}

% for coloring text
\usepackage[svgnames]{xcolor}

% package and command dependency boundary

% NOTE: JH jul 5, 2016 I didn't find any references to adjustwidth. Delete after Aug 2016
% indent paragraphs via adjustwidth
% \usepackage{changepage}

% for custom headers and footers
\usepackage{fancyhdr}
\setlength{\headheight}{14\RtRelPt}
\newcommand{\RtDoubleHRule}{
  \begin{minipage}{\textwidth}
    \hrule width \hsize height 0.19\RtRelPt
    \kern 1.6\RtRelPt
    \hrule width \hsize height 0.19\RtRelPt
  \end{minipage}
}
\newcommand{\RtFooterContent}{
  <% if @include_meta_info %>
    \fancyfoot[L]{<%= @date_code %>} % outside
    \fancyfoot[C]{\emph{<%= @footer_title %>}} % center
    \fancyfoot[R]{\textscale{0.67}{<%= @additional_footer_text %> Rev. <%= @latest_commit_hash %>}} % inside
  <% end %>
}

% redefine fancyhdr's headrule command to insert negative \vspace before \hrule
% to bring lower hrule closer to header text.
\makeatletter
\renewcommand{\headrule}{{\if@fancyplain\let\headrulewidth\plainheadrulewidth\fi
    \vspace*{-0.125\RtRelPt}\hrule\@height\headrulewidth\@width\headwidth \vskip-\headrulewidth}}
\makeatother

% specify regular pagestyle
\fancypagestyle{RtPageStyle}{
  \fancyhf{}
  \fancyhfoffset[LE]{0mm}
  <% if @is_primary_repo %>
    % single line in header (default)
    \renewcommand{\headrulewidth}{0.19\RtRelPt}
    % double line in footer
    \renewcommand{\footrule}{\RtDoubleHRule\par}
  <% else %>
    % no line in header
    \renewcommand{\headrulewidth}{0mm}
    % no line in footer (default)
  <% end %>
  \fancyhead[EL,OR]{<%= "\\hrule height 0.19\\RtRelPt \\kern 0.33\\RtRelPt"  if @is_primary_repo %><%= @page_number_command %>} % outside
  \fancyhead[ER]{<%= @header_text %>} % inside even
  \fancyhead[OL]{<%= @header_title %>} % inside odd
  \RtFooterContent
}
\pagestyle{RtPageStyle} % apply custom pagestyle

% override pagestyle for first page
\fancypagestyle{RtFirstPageStyle}{
  \fancyhf{}
  \renewcommand{\headrulewidth}{0mm} % no line in header
  <% if @is_primary_repo %>
    % double line in footer
    \renewcommand{\footrule}{\RtDoubleHRule\par}
  <% else %>
    % no line in footer (default)
  <% end %>
  \RtFooterContent
}

% for custom page layout
\usepackage[<%= @page_settings %>]{geometry}
\setlength{\marginparwidth}{0pt}

% prevent hyphenation
% This URL has good info on alternative approaches and their pros and cons:
% http://www.tex.ac.uk/cgi-bin/texfaq2html?label=hyphoff
\usepackage[none]{hyphenat}
\sloppy

% for showing layout parameters on separate page in document
% (uncomment next line and the \layout{} command inside document)
% \usepackage{layout}

% uncomment this to display layout boundaries in the document on every page.
% \usepackage{showframe}

% command to render gap mark. Pass the text to be highlighted as argument.
\newcommand{\RtGapMarkText}[1]
  {\textcolor{red}{#1}}

% command to render auto gap mark number.
\newcounter{RtGapMarkCounter}
\setcounter{RtGapMarkCounter}{3}
\newcommand{\RtGapMarkNumber}
  {%
    \textcolor{red}{%
      \textnormal{%
        \textsuperscript{\{\theRtGapMarkCounter\}}}}%
    \stepcounter{RtGapMarkCounter}}

% command to render paragraph number. Pass the para number as argument.
\newcommand{\RtParagraphNumber}[1]
<% if @polyglossia_default_language %>
  {\noindent\makebox[\parindent][l]{\raisebox{0.45ex}{{\textscale{0.67}{#1}}}}}
<% else %>
  {\paragraphnumberfont\noindent\makebox[\parindent][l]{\raisebox{0.45ex}{{\textscale{0.67}{#1}}}}\rtmainfont}
<% end %>

% command to render record_mark. Pass rid as param
\newcommand{\RtRecordMark}[1]
  {\noindent\colorbox{LightGrey}{Record#1}\par}

% command to emulate lower-case small-caps chars
\newcommand{\RtSmCapsEmulation}[1]
  {\textscale{0.7}{#1}}

% command to render last eagle
\newcommand{\RtLastEagle}
  {\hspace*{\fill}~\mbox{\raisebox{-0.5ex}ï›¡}\penalty -9999}

% enviroment to render first eagle
\newenvironment{RtFirstEagle}
  <%= @first_eagle %>
  {}

% environment to render idparagraph paragraphs
\newenvironment{RtIdParagraph}
  {
    \setlength{\parindent}{0pt}
    \fontsize{8\RtRelPt}{10.5\RtRelPt}\selectfont
  }
  {\par}

% environment to render idtitle1 paragraphs
\newenvironment{RtIdTitle1}
  {
    \needspace{350\RtRelPt}
    \vspace*{\fill}
    \begin{center}
      <%= @polyglossia_default_language ? '' : '\titlefont' %>
      \fontsize{10\RtRelPt}{12\RtRelPt}\selectfont
  }
  {
    \end{center}
  }

% environment to render idtitle2 paragraphs
\newenvironment{RtIdTitle2}
  {
    \par
    \begin{center}
      <%= @polyglossia_default_language ? '' : '\titlefont' %>
      \fontsize{8\RtRelPt}{9.6\RtRelPt}\selectfont
  }
  {
      \par
    \end{center}
  }

% environment to render meta info
\newenvironment{RtMetaInfo}
  {
    \par
    \fontsize{8\RtRelPt}{9.6\RtRelPt}\selectfont
  }
  {
    \par
  }

% environment to render .first_par
\newenvironment{RtFirstPar}
  {
    \par
    \setlength{\parskip}{0pt plus 0pt minus 0pt} % to reduce vert space between title and first paragraph
  }
  {
    \par
  }

% environment to render .indent_for_eagle
% used for increasing the indention of a .normal paragraph that follows a
% single line paragrpah that starts the file and contians an eagle
\newenvironment{RtIndentForEagle}
  {
    \par
    \setlength{\parindent}{22\RtRelPt}
  }
  {
    \par
  }

% environment to render .normal
\newenvironment{RtNormal}
  {
    \par
  }
  {
    \par
  }

% environment to render translator omit in green
\newenvironment{RtOmit}
  {\par\color{Green}}
  {\par}

% environment to render text in the primary font
% only used for the recording_merged export where we have foreign and english text
\newenvironment{RtPrimaryFont}
  {\primaryfont}
  {}

% environment to render questions
\newenvironment{RtQuestion}
  {
    \par
    \noindent
    \hangindent=25\RtRelPt
    \hangafter=1
  }
  {
    \par
  }

% environment to render scr paragraphs when they start with an eagle
\newenvironment{RtScrWithEagle}
  {
    \par
    \leftskip=20.236\RtRelPt
    \rightskip=20.236\RtRelPt
    \setlength{\parindent}{0\RtRelPt}
  }
  {
    \par
  }

% environment to render scr paragraphs
\newenvironment{RtScr}
  {
    \par
    \leftskip=20.236\RtRelPt
    \rightskip=20.236\RtRelPt
    \setlength{\parindent}{7.95\RtRelPt}
  }
  {
    \par
  }

% environment to render song paragraphs.
\newenvironment{RtSong}
  {
    \par
    \leftskip=60\RtRelPt
    \rightskip=30\RtRelPt
    \setlength{\parindent}{-8\RtRelPt}
    \nopagebreak
    \setlength{\parskip}{0pt plus 0pt minus 0pt}
  }
  {
    \par
  }

% environment to render split pairs in pdf_recording_merged
\newenvironment{RtSplitPair}
  {
    \begin{minipage}{\textwidth}
      \setlength{\parskip}{3\RtRelPt}
      \setlength{\parindent}{18\RtRelPt}
  }
  {
    \end{minipage}
  }

% environment to render stanza paragraphs.
\newenvironment{RtStanza}
  {
    \par
    \leftskip=60\RtRelPt
    \rightskip=30\RtRelPt
    \setlength{\parindent}{-8\RtRelPt}
  }
  {
    \par
  }

% environment to render level3 header
\newenvironment{RtSubTitle}
  {
    \begin{center}
      <%= @polyglossia_default_language ? '' : '\titlefont' %>
      \fontsize{10\RtRelPt}{10.5\RtRelPt}\selectfont
  }
  {
    \end{center}
  }

% environment to render level1 header
\newenvironment{RtTitle}
  {
    \setlength{\parindent}{0\RtRelPt}
    \begin{minipage}{\textwidth}
      \par
      \begingroup
        \vspace*{-3.248\RtRelPt}
        {
          \color{<%= @is_primary_repo ? 'black' : 'white' %>}
          \hrule width \hsize height 0.19\RtRelPt
        }
        \vspace*{4.354\RtRelPt}
        \begin{center}
          \begin{spacing}{1.2311}
            <%= @polyglossia_default_language ? '' : '\titlefont' %>
            \fontsize{22\RtRelPt}{26.4\RtRelPt}\selectfont
  }
  {
            \par
            \vspace*{6.733\RtRelPt}
            {
              \color{<%= @is_primary_repo ? 'black' : 'white' %>}
              \hrule width \hsize height 0.19\RtRelPt
            }
            \setstretch{0}
          \end{spacing}
        \end{center}
        \vspace*{<%= @title_vspace %>pt}
      \endgroup
    \end{minipage}
  }

% environment to render level2 header
\newenvironment{RtTitle2}
  {
    \begin{center}
      \begin{spacing}{1.2311}
        <%= @polyglossia_default_language ? '' : '\titlefont' %>
        \fontsize{16\RtRelPt}{19.2\RtRelPt}\selectfont
  }
  {
      \end{spacing}
      \vspace*{<%= @title_vspace %>pt}
    \end{center}
  }

% avoid widows and orphans
\widowpenalty=5000
\clubpenalty=5000

% set rubber value between paras for flushbottom
\setlength{\parskip}{3\RtRelPt plus 3\RtRelPt minus 0.2\RtRelPt}
\setlength{\parindent}{18\RtRelPt}
\setlength{\emergencystretch}{15\RtRelPt} % to prevent lines from sticking out on the right
\setlength{\topskip}{0pt}

% single spaces between sentences
\frenchspacing

\leading{<%= @font_leading %>pt} % don't use \RtRelPt here since \relscale already scales all font metrics

\begin{document}

  \relscale{<%= @scale_factor %>} % scale all fonts in document (to be able to use this template for both book and enlarged)

  \thispagestyle{RtFirstPageStyle} % to have same header and footer on title page

  <%= @body %>

  <%= @meta_info %>
  <%= @version_control_page %>

  % uncomment to display two pages with layout parameters
  %\newpage
  %\layout{}

\end{document}
